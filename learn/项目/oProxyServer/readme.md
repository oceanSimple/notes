# â™¾ï¸é¡¹ç›®ç»“æ„

> è¯´æ˜:
> - å¦‚æœä½ è¦ä½¿ç”¨http, é‚£ä¹ˆç«¯å£å·é»˜è®¤æ˜¯8080, å¦‚æœå¼€å¯äº†https, åˆ™ä½¿ç”¨çš„æ˜¯443ç«¯å£å·. é»˜è®¤é…ç½®ä¸ºä¸å¼€å¯https
- oProxyServer: åå‘ä»£ç†æœåŠ¡å™¨é¡¹ç›®
- server_8000: æµ‹è¯•æœåŠ¡å™¨, ç«¯å£ä¸º8000
- server_8001: æµ‹è¯•æœåŠ¡å™¨, ç«¯å£ä¸º8001

# â™¾ï¸é¡¹ç›®è¯´æ˜

æœ¬é¡¹ç›®é‡‡ç”¨Cangjieè¯­è¨€å¼€å‘, å®ç°äº†åŸºç¡€çš„åå‘ä»£ç†æœåŠ¡å™¨åŠŸèƒ½.
- é…ç½®æ–‡ä»¶: æä¾›ç›´æ¥ä¿®æ”¹æ–‡ä»¶ä»¥åŠapiåŠ¨æ€æ›´æ–°é…ç½®æ–‡ä»¶ä¸¤ç§æ–¹å¼
- å¼€å¯httpsåŠŸèƒ½: ç”¨æˆ·å¯ä»¥å°†ç”³è¯·çš„httpsè¯ä¹¦æ”¾åœ¨é¡¹ç›®æ–‡ä»¶ä¸­, å¼€å¯https
- èº«ä»½éªŒè¯æ¨¡å—: å®¢æˆ·ç«¯åœ¨è®¿é—®é™¤é…ç½®æ–‡ä»¶apiå¤–, éœ€è¦åœ¨headerä¸­åŠ ä¸Šèº«ä»½éªŒè¯æ‰å‡†è®¸è®¿é—®
- è¯·æ±‚è½¬å‘: åŠç½‘å…³åŠŸèƒ½, å°†æ¥å—çš„è¯·æ±‚æ ¹æ®é…ç½®æ–‡ä»¶è¿›è¡Œè½¬å‘
- è´Ÿè½½å‡è¡¡: æä¾›å‡ ç§é»˜è®¤çš„è´Ÿè½½å‡è¡¡æ¨¡å¼, å¯åœ¨locationä¸­é€‰æ‹©
- é™æ€ç¼“å­˜: ä¿å­˜ `GET` è¯·æ±‚è¿”å›çš„ `HTML` é™æ€ç¼“å­˜
- è‡ªå®šä¹‰æ’ä»¶: å¼€å‘è€…å¯ä»¥ä¾¿æ·çš„å¼€å‘å…¶ä»–æ’ä»¶, å¹¶æŠ•å…¥ä½¿ç”¨
- è·¯ç”±é‡å†™: é€šè¿‡ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼é…ç½®rewrite, è¾¾åˆ°è·¯ç”±é‡å†™çš„æ•ˆæœ





## ğŸ’«é…ç½®æ–‡ä»¶
- ç›´æ¥ä¿®æ”¹æ–‡ä»¶: ç›´æ¥å‰å¾€ `./oProxyServer/src/config.json` æ–‡ä»¶è¿›è¡Œä¿®æ”¹. 
	- æ³¨æ„, å½“å‰ç‰ˆæœ¬éœ€è¦ä¸¥æ ¼éµå¾ªé…ç½®æ–‡ä»¶ç¼–å†™è¦æ±‚, ä¸èƒ½éšä¾¿åˆ å‡å­—æ®µ
	- ä¿®æ”¹å®Œé…ç½®æ–‡ä»¶å, éœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ
- è°ƒç”¨å†…ç½®apiåŠ¨æ€ä¿®æ”¹
	- è°ƒç”¨apiæ—¶, è¯·æ±‚å¤´è¦åŒ…å« `oproxykey` å­—æ®µ, ç”¨æ¥åˆ¤æ–­èº«ä»½
	- ä½¿ç”¨apiä¿®æ”¹é…ç½®, æ— éœ€é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆ

## ğŸ’«https

- é¦–å…ˆå°†ç”³è¯·è¯ä¹¦å, å¾—åˆ°çš„ `.crt` å’Œ `.key` æ–‡ä»¶æ”¾åœ¨ `./oProxyServer/src` ç›®å½•ä¸‹
- ä¿®æ”¹é…ç½®æ–‡ä»¶
	- https: æ›´æ”¹ä¸ºtrue
	- httpsOptions: key å’Œ cert å­—æ®µåˆ†åˆ«è®¾ç½®æˆæˆ‘ä»¬ `.crt` å’Œ `.key` çš„å®Œæ•´æ–‡ä»¶å
- å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶apiåŠ¨æ€ä¿®æ”¹é…ç½®æ–‡ä»¶
- æœ€åé‡å¯æœåŠ¡å™¨, ä½ å°†å¯åŠ¨ç›‘å¬ `https://0.0.0.0:443` çš„æœåŠ¡å™¨

## ğŸ’«èº«ä»½éªŒè¯

> èº«ä»½éªŒè¯æ¨¡å—é‡‡ç”¨jwt

- åœ¨é…ç½®locationæ—¶, å¯è‡ªç”±é€‰æ‹©æ˜¯å¦å¼€å¯jwtåŠŸèƒ½(true æˆ–è€… false)
- jwtèº«ä»½ç 
	- æ—¢å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶apiè·å¾—: /oproxy/admin/jwt/sign (è®°å¾—åŠ ä¸Š`oproxykey`)
	- ä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æœåŠ¡, æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ `jwt-secret` ç§é’¥è¿›è¡Œç”Ÿæˆ
- åœ¨è°ƒç”¨æœåŠ¡æ—¶, è¯·æ±‚å¤´é…ç½® `Authorization` , å€¼ä¸º `Bearer ` + jwtèº«ä»½ç (æ³¨æ„ä¸­é—´æœ‰ä¸ªç©ºæ ¼)


## ğŸ’«è¯·æ±‚è½¬å‘

> è¯·æ±‚è½¬å‘ä¸»è¦ä¾èµ–é…ç½®æ–‡ä»¶ä¸­çš„ `location` å’Œ `upstream`

- é¦–å…ˆé…ç½®upstream
```json
        {
            "name": "ping",
            "group": [
                {
                    "host": "localhost:8000",
                    "weight": 1
                },
                {
                    "host": "localhost:8001",
                    "weight": 1
                }
            ]
        },
```
  - nameæ˜¯è¯¥upstreamçš„æ ‡è¯†ç¬¦, åé¢locationä¹Ÿé€šè¿‡nameä½¿ç”¨upstream
  - group.host: è½¬å‘çš„ç›®æ ‡åœ°å€
  - group.weight: æƒé‡, ç”¨äºè´Ÿè½½å‡è¡¡æ¨¡å—

- é…ç½®location
```json
        {
            "path": "/ping",
            "upstream": "ping",
            "jwt": true,
            "balance": "round-robin"
        },
```
  - path: è½¬å‘è§¦å‘çš„å‰ç¼€
  - upstream: è°ƒç”¨çš„upstreamçš„name
  - jwt: æ˜¯å¦å¼€å¯èº«ä»½éªŒè¯
  - balance: è´Ÿè½½å‡è¡¡çš„æ–¹å¼é€‰æ‹©

## ğŸ’«é™æ€ç¼“å­˜

> - é¡¹ç›®é‡‡ç”¨çš„æ˜¯å†…å­˜ç¼“å­˜çš„æ–¹æ³•, é»˜è®¤å­˜å‚¨ä¸ªæ•°ä¸º20ä¸ª
> - ç¼“å­˜æ›¿æ¢æ–¹æ³•é»˜è®¤é‡‡ç”¨LRU
> - æš‚æ—¶åªä¿å­˜ `GET`  + `HTML` çš„ç›¸åº”æ–‡ä»¶





## ğŸ’«è´Ÿè½½å‡è¡¡

æä¾›äº†å‡ ç§åŸºæœ¬çš„è´Ÿè½½å‡è¡¡ç®—æ³•
- round-robin(è½®è¯¢ç®—æ³•): å¹³å‡åˆ†é…è°ƒç”¨æœºä¼š
- random(éšæœºç®—æ³•): éšæœºè°ƒç”¨ç›®æ ‡æœåŠ¡
- smooth-weighted-round-robin(å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•): åŠ æƒè½®è¯¢ç®—æ³•çš„æ”¹è‰¯ç‰ˆ, å¯ä»¥ä¿è¯æ ¹æ®æœåŠ¡å™¨çš„æƒé‡åˆ†é…è¯·æ±‚ï¼ŒåŒæ—¶ç¡®ä¿è¯·æ±‚åˆ†å¸ƒæ›´åŠ å‡åŒ€ï¼Œé¿å…åŒä¸€æœåŠ¡å™¨åœ¨çŸ­æ—¶é—´å†…è¢«è¿ç»­é€‰ä¸­ã€‚
- ip-hash(æºåœ°å€å“ˆå¸Œç®—æ³•): æ ¹æ®å®¢æˆ·ç«¯çš„IPåœ°å€, é€šè¿‡å“ˆå¸Œç®—æ³•, é€‰å‡ºä¸€ä¸ªå›ºå®šçš„èŠ‚ç‚¹,ä½¿å¾—åŒä¸€ä¸ªIPåœ°å€çš„è¯·æ±‚, å§‹ç»ˆè®¿é—®åŒä¸€ä¸ªèŠ‚ç‚¹. é€‚ç”¨äºè´­ç‰©è½¦ç­‰éœ€è¦ä¿æŒä¼šè¯çš„åœºæ™¯

## ğŸ’«è‡ªå®šä¹‰æ’ä»¶

> åœ¨è¯¥æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ’ä»¶å‡½æ•°: `./oProxyServer/src/web_module/middleware`

```java
package o_proxy_server.web_module.middleware

import o_proxy_server.model.web.Context

protected func newHandler(ctx: Context): Unit {
}

```

> åœ¨a.cjæ–‡ä»¶ä¸­åº”ç”¨æ’ä»¶: `./oProxyServer/src/web_module/middleware/a.cj`
> ä½¿ç”¨handlers.add(newHandler)
> æ³¨æ„, ä»£ç è¡Œæ•°é¡ºåºå³ä¸ºä¸­é—´ä»¶çš„è°ƒç”¨é¡ºåº, è€Œæœ¬é¡¹ç›®è‡ªå®šä¹‰çš„Contextç±», å¯ä»¥å‰å¾€o_proxy_server.model.web.ContextæŸ¥çœ‹è¯¦æƒ…

```java
public func getMiddlewareHandler(): ArrayList<(Context) -> Unit> {
    let handlers = ArrayList<(Context) -> Unit>()

    // admin api æ’ä»¶
    handlers.add(adminApiApiHandler)

    // jwt æ’ä»¶
    handlers.add(jwtHandler)

    // è·¯ç”±é‡å†™æ’ä»¶
    handlers.add(rewriteHandler)

    // !!!æ³¨æ„, memoryCacheHandler å’Œ gatewayHandler çš„é¡ºåºä¸èƒ½é¢ å€’
    handlers.add(memoryCacheHandler)
    handlers.add(gatewayHandler)

    // è¿™ä¸ªå¿…é¡»æ˜¯æœ€åä¸€ä¸ª
    // é€€å‡ºå‡½æ•°
    handlers.add(exitHandler)

    return handlers
}
```

## ğŸ’«è·¯ç”±é‡å†™rewrite

> ä¸‹é¢æ˜¯rewriteé…ç½®æ–‡ä»¶æ¨¡æ¿
> è¯¥é¡¹ç›®æš‚æ—¶åªå®ç°äº† regex å’Œ replacement éƒ¨åˆ†
> æ³¨æ„, rewriteæ¨¡å—åœ¨è¯·æ±‚è½¬å‘æ¨¡å—ä¹‹å‰, å› æ­¤åå‘ä»£ç†æœåŠ¡å™¨ä¼šå…ˆè¿›è¡Œé‡å†™, å†æ ¹æ®é‡å†™çš„è·¯å¾„è¿›è¡Œè¯·æ±‚è½¬å‘

```json
	{
		"conditions": [
			{
				"variable": "$http_user_agent",
				"pattern": "Mobile",
				"operators": "~*"
			}
		],
		"regex": "^/user/(\\d+)",
		"replacement": "/profile?id=$1",
		"flags": [
			"last"
		]
	},
```

- regex: å³æ­£åˆ™è¡¨è¾¾å¼éƒ¨åˆ†, æ¨èä»¥^å¼€å¤´
- replacement: é‡å†™ç›®æ ‡è·¯å¾„. æ”¯æŒ$è¡¨è¾¾å¼(å³æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢çš„éƒ¨åˆ†ä¼šæŒ‰ç…§èµ·å§‹ä¸º1çš„åºå·è¿›è¡Œå¡«å……)


> æ¯”å¦‚
> å®¢æˆ·ç«¯è®¿é—®è·¯å¾„: /user/12
> é‡å†™è·¯å¾„: /profile?id=12



# â™¾ï¸é…ç½®æ–‡ä»¶apiè¯¦æƒ…

> - è°ƒç”¨apiæ—¶, è¯·æ±‚å¤´è¦åŒ…å« `oproxykey` å­—æ®µ, ç”¨æ¥åˆ¤æ–­èº«ä»½!!!
> - å¦‚æœéœ€è¦è¯¦ç»†çš„ç¤ºä¾‹, è¯·è®¿é—®: https://apifox.com/apidoc/shared-d54dc3e2-5298-481a-8e91-6859d4f9789d


# â™¾ï¸è®¾è®¡æ€è·¯

> è®¾è®¡æ€è·¯æ–‡æ¡£é“¾æ¥: https://www.yuque.com/ocean-0z5us/azabem/hqnewrb8ibb1zs3h?singleDoc# ã€Šè®¾è®¡æ€è·¯ã€‹

