# â™¾ï¸httpå¤„ç†å™¨
## ğŸ’«å…¥å£ - httpServer
![[Pasted image 20250215220626.png|500]]

> æˆå‘˜å˜é‡
- server: æ ‡å‡†åº“ä¸­http.Server, ç”¨æ¥å¯åŠ¨httpç«¯å£

> æˆå‘˜å‡½æ•°
- run: å¯åŠ¨ç›‘å¬å™¨

## ğŸ’«è·¯ç”±å¤„ç†å™¨ - HttpDistributor

> è‡ªå®šä¹‰è·¯ç”±å¤„ç†å™¨, éœ€è¦ç»§æ‰¿æ ‡å‡†åº“ä¸­http.HttpRequestDistributor

```java
public class HttpDistributor <: http.HttpRequestDistributor {
    public func distribute(_: String): http.HttpRequestHandler {
        return RootHandler()
    }

    public func register(_: String, _: (http.HttpContext) -> Unit): Unit {
}

public func register(_: String, _: http.HttpRequestHandler): Unit {
}
}

public class RootHandler <: http.HttpRequestHandler {
    public func handle(ctx: http.HttpContext): Unit {
        let myCtx = middleware.Context(ctx.request, ctx.responseBuilder)
        myCtx.next()
    }
}
```

> åœ¨æ„é€ serveræ—¶æ³¨å†Œè‡ªå®šä¹‰å¤„ç†å™¨

```java
public init() {
	server = http.ServerBuilder().addr(addr).port(port).distributor(HttpDistributor()).build()
}
```

# â™¾ï¸æ’ä»¶æ¨¡å—
## ğŸ’«ä¸Šä¸‹æ–‡ - Context(æ ¸å¿ƒ)
![[Pasted image 20250215221920.png]]

> æˆå‘˜å‚æ•°
- request: ä¿å­˜æ ‡å‡†åº“ä¸­http.Context.HttpRequest
- response: ä¿å­˜æ ‡å‡†åº“ä¸­http.Context.HttpResponseBuilcer
- handlers: ç”¨æ¥ä¿å­˜æ‰€æœ‰å¾…æ‰§è¡Œçš„ä¸­é—´ä»¶
- å…¶ä»–çš„å‚æ•°, éƒ½æ˜¯ç”¨æ¥åœ¨ä¸åŒä¸­é—´ä»¶ä¸­è¿›è¡Œæ•°æ®ä¼ é€’çš„, æ•…ä¸ä¸“é—¨è¯´æ˜

> æˆå‘˜å‡½æ•°
- next: æš‚æ—¶ä¸­æ­¢å½“å‰ä¸­é—´ä»¶æ“ä½œ, æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶
- terminate: å³åˆ»å¼€å§‹ä¸­æ­¢åç»­æ‰€æœ‰çš„ä¸­é—´ä»¶æ“ä½œ

### ä¸­é—´ä»¶æ‰§è¡Œæ“ä½œ

> æ ¸å¿ƒç»„ä»¶
- index: è®¡æ•°å™¨, ç”¨æ¥è®°å½•å½“å‰æ‰§è¡Œåˆ°ç¬¬nä¸ªä¸­é—´ä»¶
- handler: ä¿å­˜æ‰€æœ‰ä¸­é—´ä»¶çš„æ•°ç»„

```java
protected var index: Int64
public let handlers: collection.ArrayList<(Context) -> Unit>
```

> c.next()
- æ ¹æ®indexè®¡æ•°å™¨, ä¾æ¬¡æ‰§è¡Œä¸­é—´ä»¶

```java
// æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶
public func next() {
    this.index++
    while (index < this.handlers.size) {
        this.handlers[this.index](this)
        this.index++
    }
}
```

> c.terminate()
- å°†è®¡æ•°å™¨ç½®ä¸ºæ•°ç»„é•¿åº¦, å³ç»“æŸä¸­é—´ä»¶æ‰§è¡Œæ“ä½œ

```java
// ä¸­æ­¢åç»­ä¸­é—´ä»¶çš„æ‰§è¡Œ
public func terminate() {
    this.index = this.handlers.size
}
```

æ³¨æ„, å½“ä½ éœ€è¦ä¸­æ­¢åç»­æ“ä½œæ—¶, ä¸ä»…ä»…éœ€è¦è°ƒç”¨terminateå‡½æ•°, è¿˜éœ€è¦return, ç»“æŸå½“å‰ä¸­é—´ä»¶å‡½æ•°çš„åç»­æ“ä½œ(netx()å‡½æ•°åŒç†)

æˆ‘ä»¬ä»¥jwtå¤„ç†å™¨è¿›è¡Œä¸¾ä¾‹
```java
protected func jwtHandler(ctx: Context): Unit {
    // è·å–location, åˆ¤æ–­æ˜¯å¦éœ€è¦jwtéªŒè¯
    let location = getLocation(ctx.request.url.toString())
    if (location.isNone() || location.getOrThrow().jwt == false) {
        ctx.next()
        return
    }
    // ä»è¯·æ±‚å¤´ä¸­è·å–token
    let token = getToken(ctx)
    if (token.isNone()) {
        response401(ctx)
        ctx.terminate()
        return
    }
    // è§£ætoken
    let flag = parseJwtToken(token ?? "")
    if (!flag) {
        response401(ctx)
        ctx.terminate()
        return
    }
    ctx.next()
}
```

## ğŸ’«ç½‘å…³æ¨¡å—(æ ¸å¿ƒ)
> æµç¨‹ä»‹ç»
1. ä»é…ç½®æ–‡ä»¶ä¸­è·å–å®Œæ•´è·¯å¾„
	1. æ ¹æ®url, åœ¨locationsä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç¬¦åˆçš„å‰ç¼€
	2. æ‰¾åˆ°locationå, æ ¹æ®locationä¿å­˜çš„upstreamä¿¡æ¯, æ‰¾åˆ°upstreamä¿¡æ¯
	3. è°ƒç”¨è´Ÿè½½å‡è¡¡æ¨¡å—, ä»upstreamä¸­æŒ‘é€‰ä¸€ä¸ªè½¬å‘åœ°å€
	4. æ‹¼æ¥å®Œæ•´çš„è½¬å‘è·¯å¾„
2. å¦‚æœè·å–æˆåŠŸ, è¿›è¡Œè¯·æ±‚è½¬å‘
	1. é€‰æ‹©æ˜¯http or https
	2. ä½¿ç”¨http.Clientè®¿é—®ç›®æ ‡æœåŠ¡å™¨
	3. å°†clientæ¥æ”¶çš„responseå­˜å…¥context.response
3. å¦‚æœè·å–å¤±è´¥, åˆ™è¿”å›404

> 1

```java
// upstream + locationçš„è·¯å¾„è·å–å‡½æ•°
private func getCompleteRequestPath(url: String): String {
    var result = ""
    // åˆ¤æ–­æ˜¯å¦å­˜åœ¨location
    let location = getLocation(url)
    if (location.isNone()) {
        return result
    }

    // å»æ‰urlçš„å‰ç¼€
    let newURL = deleteUrlPrefix(url, location.getOrThrow().prefix)
    // æ ¹æ®locationä¸­çš„upstreamName, æ‰¾åˆ°å¯¹åº”çš„upstream
    let upstream = getUpstream(location.getOrThrow().upstreamName)
    // åˆ¤æ–­æ˜¯å¦æœ‰upstream
    if (upstream.isNone()) {
        return result
    }
    // æ ¹æ®upstreamå’Œlocationä¸­çš„balance, æ‰¾åˆ°å¯¹åº”çš„targetHost
    let targetHost = BALANCEHANDLER.selectTarget(upstream.getOrThrow(), location.getOrThrow().balance)
    // æ‹¼æ¥å®Œæ•´è·¯å¾„
    result = targetHost + newURL

    return result
}
```

> 2

```java
private func reverseRequest(ctx: Context, targetPath: String) {
    let requestPrefix = "http://"
    let path = requestPrefix + targetPath // ç›®æ ‡è®¿é—®è·¯å¾„

    let client = CLIENT
    let rsp: http.HttpResponse
    // æ ¹æ®methodé€‰æ‹©è¯·æ±‚æ–¹å¼
    match (ctx.request.method) {
        case "GET" => rsp = client.get(path)
        case "POST" => rsp = client.post(path, ctx.request.body)
        case "PUT" => rsp = client.put(path, ctx.request.body)
        case "DELETE" => rsp = client.delete(path)
        case _ => rsp = client.get(path)
    }
    ctx.response.status(rsp.status)
    ctx.response.body(rsp.body)
}
```

> 3

```java
private func response404(ctx: Context): Unit {
    ctx.response.status(404)
    ctx.response.header("Content-Type", "text/html")
    ctx.response.body(util.HTML404)
}
```

## ğŸ’«jwtæ¨¡å—
> æµç¨‹ä»‹ç»

1. æ ¹æ®url, ä»locationä¸­è¯»å–ç›¸åº”é…ç½®, åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œjwté‰´æƒ
2. éœ€è¦
	1. ä»è¯·æ±‚å¤´ä¸­è·å¾—jwt token
	2. åˆ¤æ–­jwtæ˜¯å¦åˆæ³•
3. ä¸éœ€è¦
	1. ç›´æ¥æ”¾è¡Œ


> 2.a

```java
private func getToken(ctx: Context): ?String {
    let authorization = ctx.request.headers.get("Authorization")
    if (authorization.isEmpty()) {
        return None
    }
    for (str in authorization) {
        if (str.startsWith("Bearer ")) {
            return str.removePrefix("Bearer ")
        }
    }
    return None
}
```

> 2.b
- TODO éœ€è¦æ³¨æ„çš„æ˜¯, å½“å‰æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„jwtåº“, å› æ­¤æš‚æ—¶è°ƒç”¨å…¶ä»–è¯­è¨€çš„æœåŠ¡è¿›è¡Œjwtæ ¡éªŒ

```java
// TODO æš‚æ—¶æ²¡ç”¨æ‰¾åˆ°åˆé€‚çš„jwtè§£æåº“, å› æ­¤è°ƒç”¨å…¶ä»–è¯­è¨€çš„æœåŠ¡è¿›è¡Œè§£æ
private func parseJwtToken(token: String): Bool {
    let client = http.ClientBuilder().build()
    let url = "http://localhost:7000/jwt/parse?token=" + token
    let rsp = client.get(url)
    client.close()
    if (rsp.status == 200) {
        return true
    }
    return false
}
```

## ğŸ’«å†…å­˜ç¼“å­˜æ¨¡å—

> è¯¥æ¨¡å—æš‚æ—¶åªæ”¯æŒGETè¯·æ±‚, åŒæ—¶å“åº”ä½“æ˜¯html

> æµç¨‹è¯´æ˜

1. åˆ¤æ–­è¯·æ±‚æ–¹æ³•æ˜¯å¦æ˜¯GET, è‹¥é, åˆ™ç›´æ¥ç»“æŸ
2. åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨
	1. è‹¥å­˜åœ¨, åˆ™ä¸­æ­¢åç»­çš„ç½‘å…³æœåŠ¡, ç›´æ¥æ ¹æ®ç¼“å­˜å†…å®¹è¿”å›
3. è‹¥ä¸å­˜åœ¨ç¼“å­˜, åˆ™ç»§ç»­è¿›è¡Œç½‘å…³æœåŠ¡
	1. æ ¹æ®ç½‘å…³æœåŠ¡ç»“æœ, åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿å­˜ç¼“å­˜

> 1

```java
// å¦‚æœè¯·æ±‚æ–¹æ³•ä¸æ˜¯GET, é‚£ä¹ˆå°±ç›´æ¥ç»“æŸç¼“å­˜ä¸­é—´ä»¶å¤„ç†
if (ctx.request.method != "GET") {
    ctx.next()
    return
}
```

> 2.a

```java
// è·å–è¯·æ±‚çš„path, åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾
let path = ctx.request.url.toString()
let cahce = MEMRORY_CACHE_LRU.get(path)

// å¦‚æœç¼“å­˜å­˜åœ¨, é‚£ä¹ˆå°±ä¸éœ€è¦åç»­ç½‘å…³çš„è¯·æ±‚è½¬å‘äº†
// åŒæ—¶ä¹Ÿä¸éœ€è¦åç»­ä¿å­˜ç¼“å­˜çš„æ“ä½œ
if (cahce.isSome()) {
    ctx.response.body(cahce.getOrThrow())
    ctx.response.header("Content-Type", "text/html")
    ctx.response.status(200)

    // TODO æ‰“å°, ç”¨äºæ˜¾ç¤ºè°ƒç”¨äº†ç¼“å­˜(åç»­åˆ é™¤)
    print(LOG.info("${path} use memory cache"))

    // ç»ˆæ­¢åç»­æ‰€æœ‰çš„ä¸­é—´ä»¶
    ctx.terminate()
    return
}
```

> 3

```java
// å¦‚æœç¼“å­˜ä¸å­˜åœ¨, åˆ™å…ˆè¿›è¡Œç½‘å…³è¯·æ±‚è½¬å‘
ctx.cacheFlag = true // è®¾ç½®ç¼“å­˜æ ‡å¿—, å‘Šè¯‰åç»­ä¸­é—´ä»¶éœ€è¦ä¿å­˜ç¼“å­˜
ctx.next()
```

> 4

```java
// ç½‘å…³è¯·æ±‚è½¬å‘ç»“æŸå, å¦‚æœè¿”å›ç»“æœæ˜¯200, åŒæ—¶ä¹Ÿæ˜¯htmlç±»å‹
// é‚£ä¹ˆå°±å°†ç»“æœä¿å­˜åˆ°ç¼“å­˜ä¸­

// 1. åˆ¤æ–­çŠ¶æ€ç æ˜¯å¦ä¸º200
if (ctx.statusCode != 200) {
    return
}
// 2. åˆ¤æ–­Content-Typeæ˜¯å¦ä¸ºtext/html
if (!ctx.isHtml) {
    return
}
// 3. ä¿å­˜ç¼“å­˜
if (ctx.rspBody.isNone()) {
    return
} else {
    // print("save cache")
    MEMRORY_CACHE_LRU.put(path, ctx.rspBody.getOrThrow())
}
```

> åŒæ—¶, å¦‚æœéœ€è¦è¯¥æ’ä»¶å‘æŒ¥ä½œç”¨, éœ€è¦ç½‘å…³æœåŠ¡è¿›è¡Œé…åˆ

- åœ¨gateway.cjä¸­çš„è¯·æ±‚è½¬å‘å‡½æ•°reverseRequestä¸­, åœ¨è½¬å‘è¯·æ±‚è·å¾—å“åº”å, éœ€è¦å°†ä¸€äº›å¿…è¦çš„æ•°æ®ä¿å­˜åœ¨ä¸Šä¸‹æ–‡ä¸­, æ–¹ä¾¿ä¿å­˜ç¼“å­˜

```java
// TODO å†…å­˜ç¼“å­˜çš„å¤„ç†éƒ¨åˆ†(å¯èƒ½ä¼ç¬”)
// è¿™é‡Œéœ€è¦æ³¨æ„, æˆ‘ä»¬å†…å­˜ç¼“å­˜æ—¶, æ˜¯å°†rsp.bodyå½“ä½œStringç±»å‹ä¿å­˜çš„
// åç»­å¯èƒ½ä¼šå¯¹è§†é¢‘/å›¾ç‰‡ç­‰äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤„ç†æœ‰å½±å“!
if (ctx.cacheFlag) {
    // å°†rsp.bodyä»¥Stringç±»å‹è¯»å–
    let body = StringReader(rsp.body).readToEnd()
    // å°†bodyä¿å­˜åœ¨ctxä¸­
    ctx.rspBody = body
    // å› ä¸ºrsp.bodyæ˜¯æµ, æˆ‘ä»¬è¯»å–è¿‡äº†, æ‰€ä»¥éœ€è¦é‡æ–°è®¾ç½®body
    ctx.response.body(body)

    // ä¿å­˜Content-Type
    let ct = rsp.headers.get("Content-Type")
    for (str in ct) {
        if (str.startsWith("text/html")) {
            ctx.isHtml = true
        }
    }
```

- ç„¶ååŒæ—¶, åœ¨æ³¨å†Œä¸­é—´ä»¶æ—¶, ä¸€å®šæ˜¯å†…å­˜ç¼“å­˜æ’ä»¶åœ¨ç½‘ç®¡æ’ä»¶ä¹‹å‰æ³¨å†Œ

```java
// !!!æ³¨æ„, memoryCacheHandler å’Œ gatewayHandler çš„é¡ºåºä¸èƒ½é¢ å€’
handlers.append(memoryCacheHandler)
handlers.append(gatewayHandler)
```

# â™¾ï¸å†…å­˜ç¼“å­˜
## ğŸ’«CacheData - ç¼“å­˜å­˜å‚¨

![](https://cdn.nlark.com/yuque/0/2025/png/28907827/1737597647070-9169642b-dcba-450d-8489-5eb3655f4c40.png)

- capacity: å®¹é‡, å³ç¼“å­˜æ•°é‡æœ€å¤§å€¼
- size: å½“å‰ç¼“å­˜æ•°é‡

## ğŸ’«CacheHandler - ç¼“å­˜æ›¿æ¢ç­–ç•¥æ¥å£

```java
// ç¼“å­˜å¤„ç†å™¨: ä¸åŒçš„ç¼“å­˜æ›¿æ¢ç­–ç•¥
protected interface CacheHandler {
    // è·å–ç¼“å­˜æ•°æ®
    // å› ä¸ºCacheDataä¸­ä¿å­˜äº†ç¼“å­˜æ•°æ®, æ‰€ä»¥å¤„ç†å™¨åªéœ€è¦å‘Šè¯‰CacheDataæ•°æ®æ˜¯å¦å­˜åœ¨å³å¯
    // å…¶ä»–ç¼“å­˜æ›¿æ¢ç­–ç•¥ç”±å¤„ç†å™¨è‡ªå·±å®ç°, ä¸CacheDataæ— å…³
    func get(key: String): Bool

    // è®¾ç½®ç¼“å­˜æ•°æ®
    // å› ä¸ºCacheDataåªå…·æœ‰ä¿å­˜ç¼“å­˜æ•°æ®çš„åŠŸèƒ½, å› æ­¤ä¸çŸ¥é“æœ¬æ¬¡putæ“ä½œæ˜¯å¦ä¼šå¯¼è‡´ç¼“å­˜æ›¿æ¢
    // å› æ­¤éœ€è¦å¤„ç†å™¨é€šè¿‡è¿”å›å€¼, å‘Šè¯‰CacheDataæ˜¯å¦éœ€è¦æ›¿æ¢ç¼“å­˜
    func put(key: String, value: String, cacheData: CacheData): ?String
}
```

## ğŸ’«MemoryCache - æ ¸å¿ƒ
![](https://cdn.nlark.com/yuque/0/2025/png/28907827/1737597500837-5a1344b8-fcaa-4fb4-9d4a-787c0b18ef25.png)


> æˆå‘˜å˜é‡
- cacheData: ç”¨æ¥å­˜å‚¨ç¼“å­˜
- cacheHandler: ä¸åŒç­–ç•¥çš„ç¼“å­˜æ›¿æ¢å¤„ç†å™¨

> æˆå‘˜å‡½æ•°
- get: è·å–ç¼“å­˜
- put: æ·»åŠ ç¼“å­˜

```java
// è·å–ç¼“å­˜æ•°æ®
public func get(key: String): ?String {
    // é€šè¿‡å¤„ç†å™¨, åˆ¤æ–­ç¼“å­˜æ•°æ®æ˜¯å¦å­˜åœ¨
    let flag = this.cacheHandler.get(key)
    if (flag) {
        return this.cacheData.cache.get(key)
    } else {
        return None
    }
}

// è®¾ç½®ç¼“å­˜æ•°æ®
public func put(key: String, value: String): Unit {
    // é¦–å…ˆå°†æ•°æ®æ”¾å…¥ç¼“å­˜å¤„ç†å™¨ä¸­
    this.cacheData.cache.put(key, value)

    // é€šè¿‡å¤„ç†å™¨, åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ é™¤ç¼“å­˜æ•°æ®
    let deleteKey = this.cacheHandler.put(key, value, this.cacheData)
    if (deleteKey.isNone()) {
        return
    }
    this.cacheData.cache.remove(deleteKey.getOrThrow())
}
```

## ğŸ’«ä¸åŒç¼“å­˜æ›¿æ¢ç­–ç•¥
### LRU

å‚è€ƒæ–‡æ¡£: [146. LRU ç¼“å­˜ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰](https://leetcode.cn/problems/lru-cache/solutions/12711/lru-ce-lue-xiang-jie-he-shi-xian-by-labuladong/)

```java
protected class LruHandler <: CacheHandler {
    private let cacheList: DoubleList
    private let map: HashMap<String, Node>

    public init() {
        this.cacheList = DoubleList()
        this.map = HashMap()
    }

    // è¿”å›æ˜¯å¦å­˜åœ¨key-value
    public func get(key: String): Bool {
        // åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨
        let value = this.map.get(key)
        if (value.isNone()) {
            return false
        }

        // å¦‚æœkeyå­˜åœ¨, å…ˆé€šè¿‡makerecentlyæå‡keyçš„ä½ç½®
        this.makerecently(key)

        return true
    }

    public func put(key: String, value: String, cacheData: CacheData): ?String {
        // æ ¹æ®keyè·å–node
        let node = this.map.get(key)

        // å¦‚æœkeyå­˜åœ¨
        // åªéœ€è¦æ›´æ–°value, å¹¶æå‡ä¸ºæœ€è¿‘ä½¿ç”¨çš„. ä¸éœ€è¦è¿›è¡Œç¼“å­˜æ›¿æ¢
        if (node.isSome()) {
            // åˆ é™¤æ—§çš„æ•°æ®
            deleteKey(key)
            // æ–°æ’å…¥çš„æ•°æ®ä¸ºæœ€è¿‘ä½¿ç”¨çš„æ•°æ®
            addRecently(key, value)
            return None
        }

        // å¦‚æœkeyä¸å­˜åœ¨
        // éœ€è¦åˆ¤æ–­ç¼“å­˜æ˜¯å¦å·²æ»¡
        var deleteKey: ?String = None
        if (cacheList.size == cacheData.capacity) {
            // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´ 
            deleteKey = removeLeastRecently()
        }

        // æ·»åŠ æœ€è¿‘ä½¿ç”¨çš„å…ƒç´ 
        addRecently(key, value)

        return deleteKey
    }

    // å°†æŸä¸ªkeyæå‡ä¸ºæœ€è¿‘ä½¿ç”¨çš„
    // å¦‚æœkeyä¸å­˜åœ¨, åˆ™è¿”å›false
    private func makerecently(key: String): Bool {
        let node = this.map.get(key)
        // ä¿è¯nodeå­˜åœ¨
        if (node.isNone()) {
            return false
        }
        // ä»é“¾è¡¨ä¸­åˆ é™¤node
        this.cacheList.remove(node.getOrThrow())
        // é‡æ–°æ’å…¥åˆ°é“¾è¡¨å°¾éƒ¨
        this.cacheList.addLast(node.getOrThrow())

        return true
    }

    // æ·»åŠ æœ€è¿‘ä½¿ç”¨çš„å…ƒç´ 
    private func addRecently(key: String, value: String): Unit {
        let node = Node(key, value)
        // é“¾è¡¨å°¾éƒ¨å°±æ˜¯æœ€è¿‘ä½¿ç”¨çš„å…ƒç´ 
        this.cacheList.addLast(node)
        // åœ¨mapä¸­æ·»åŠ keyå’Œnodeçš„æ˜ å°„
        this.map.put(key, node)
    }

    // åˆ é™¤æŸä¸€ä¸ªkey
    // å¦‚æœkeyä¸å­˜åœ¨, åˆ™è¿”å›false
    private func deleteKey(key: String): Bool {
        let node = this.map.get(key)
        if (node.isNone()) {
            return false
        }
        // ä»é“¾è¡¨ä¸­åˆ é™¤
        this.cacheList.remove(node.getOrThrow())
        // ä»mapä¸­åˆ é™¤
        this.map.remove(key)

        return true
    }

    // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„å…ƒç´ 
    private func removeLeastRecently(): ?String {
        // é“¾è¡¨å¤´éƒ¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯æœ€ä¹…æœªä½¿ç”¨çš„
        let node = this.cacheList.removeFirst()
        // å¦‚æœå¾—åˆ°çš„æ˜¯None, è¯´æ˜é“¾è¡¨ä¸ºç©º, ç›´æ¥è¿”å›
        if (node.isNone()) {
            return None
        }
        // ä»mapä¸­åˆ é™¤
        this.map.remove(node.getOrThrow().key)

        return node.getOrThrow().key
    }
}

protected class Node {
    protected var key: String
    protected var value: String
    protected var prev: ?Node
    protected var next: ?Node
    public init(key: String, value: String) {
        this.key = key
        this.value = value

        this.prev = None
        this.next = None
    }

    public func equal(node: Node): Bool {
        return this.key == node.key && this.value == node.value
    }
}

protected class DoubleList {
    private var head: ?Node
    private var tail: ?Node
    protected var size: Int64

    public init() {
        let initNode = Node("", "")
        this.head = initNode
        this.tail = initNode
        head.getOrThrow().next = tail
        tail.getOrThrow().prev = head
        this.size = 0
    }

    // åœ¨é“¾è¡¨å°¾éƒ¨æ·»åŠ èŠ‚ç‚¹
    public func addLast(node: Node) {
        // initå‡½æ•°ç¡®ä¿äº†headå’Œtailä¸ä¸ºNone
        node.prev = this.tail.getOrThrow().prev
        node.next = this.tail

        this.tail.getOrThrow().prev.getOrThrow().next = node
        this.tail.getOrThrow().prev = node

        this.size++
    }

    // åˆ é™¤é“¾è¡¨ä¸­çš„nodeèŠ‚ç‚¹
    // è¿™é‡Œçš„nodeä¸€å®šå­˜åœ¨(å› ä¸ºæ˜¯ä»mapä¸­å–å‡ºæ¥çš„)
    public func remove(node: Node) {
        node.prev.getOrThrow().next = node.next
        node.next.getOrThrow().prev = node.prev

        this.size--
    }

    // åˆ é™¤é“¾è¡¨ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¹¶è¿”å›
    public func removeFirst(): ?Node {
        // å¦‚æœheadä¸tailç›¸åŒ, è¯´æ˜é“¾è¡¨ä¸ºç©º
        if (this.head.getOrThrow().next.getOrThrow().equal(this.tail.getOrThrow())) {
            return None
        }

        // è·å–ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
        let first = this.head.getOrThrow().next.getOrThrow()
        // åˆ é™¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
        this.remove(first)
        return first
    }
}
```


# â™¾ï¸admin api
## ğŸ’«å‰ç¼€æ ‘
### ğŸ’«è·¯ç”±æ ‘ç¤ºä¾‹

![[Pasted image 20250215224120.png|475]]

### ğŸ’«è·¯ç”±æ ‘ç»„ä»¶-Trie

![[Pasted image 20250215224245.png|525]]


> å‚æ•°æˆå‘˜
> - pattern: ä¿å­˜å®Œæ•´çš„è·¯ç”±. ç»“å°¾çš„partæ‰ä¿å­˜å®Œæ•´è·¯ç”±
> - part: éƒ¨åˆ†è·¯ç”±
> - children: å­è·¯ç”±
> - isWild: æ˜¯å¦æ˜¯æ¨¡ç³ŠåŒ¹é…, ä¾‹å¦‚ * æˆ– :

> å‡½æ•°æˆå‘˜
> - matchChild: æ ¹æ®è·¯ç”±å¯»æ‰¾child. insertå‡½æ•°çš„å·¥å…·
> - insert: å°†æ–°è·¯ç”±æ’å…¥åˆ°è·¯ç”±æ ‘
> - matchChildren: åŒ¹é…è·¯ç”±children. searchå‡½æ•°çš„å·¥å…·
> - search: æœç´¢åŒ¹é…è·¯ç”±å‡½æ•°

### ğŸ’«è·¯ç”±ç»„ä»¶-Router
![[Pasted image 20250215224301.png|600]]

> å‚æ•°æˆå‘˜
> - roots: è·¯ç”±æ ‘. get/post/put/deleteå„ç§methodéƒ½æœ‰ä¸€é¢—å•ç‹¬çš„æ ‘
> - handlers: ä¿å­˜å„ä¸ªè¯·æ±‚è·¯å¾„çš„å¤„ç†å™¨


> å‡½æ•°æˆå‘˜
> - handle: å¤„ç†å‡½æ•°
> - parsePattern: å¤„ç†è¯·æ±‚è·¯å¾„, æŒ‰ç…§"/"åˆ†éš”
> - addRoute: æ·»åŠ è·¯ç”±åˆ°è·¯ç”±æ ‘
> - getRoute: ä»è·¯ç”±æ ‘ä¸­è·å–è·¯ç”±, åŒæ—¶å°†è·¯ç”±å‚æ•°è§£æå‡ºæ¥


# â™¾ï¸rewrite
## ğŸ’«é…ç½®æ–‡ä»¶ç¤ºä¾‹
> json

- å½“å‰é˜¶æ®µåªéœ€è¦å…³æ³¨ rewrites.regex å’Œ rewrites.replacementå³å¯
- å‰©ä¸‹çš„å‚æ•°æš‚æ—¶æ²¡æœ‰ä½¿ç”¨
```json
"rewriteGlobal": {
        "maxRewrites": 10,
        "debug": false,
        "cacheEnabled": true
    },
"rewrites": [
	{
		"conditions": [
			{
				"variable": "$http_user_agent",
				"pattern": "Mobile",
				"operators": "~*"
			}
		],
		"regex": "^/user/(\\d+)",
		"replacement": "/profile?id=$1",
		"flags": [
			"last"
		]
	}
]
```

## ğŸ’«å˜ç§å‰ç¼€æ ‘

> ä¸ºäº†ä½¿å‰ç¼€æ ‘é€‚åº”æ­£åˆ™è¡¨è¾¾å¼, æˆ‘ä»¬å¯¹å‰é¢çš„å‰ç¼€æ ‘è¿›è¡Œäº†è°ƒæ•´

- æ·»åŠ æ ‡è¯†ç¬¦
```java
protected var needRegex: Bool = false // æ˜¯å¦éœ€è¦æ­£åˆ™åŒ¹é…
```

```java
// å¦‚æœæ˜¯æ­£åˆ™åŒ¹é…, éœ€è¦è®¾ç½®needRegexä¸ºtrue
if (part.startsWith("(") && part.endsWith(")")) {
	child.getOrThrow().needRegex = true
}
```

- æ·»åŠ é€»è¾‘
```java
// åˆ†ä¸ºä¸¤ç§æƒ…å†µ, ä¸€ç§æ˜¯éœ€è¦æ­£åˆ™åŒ¹é…, ä¸€ç§æ˜¯ä¸éœ€è¦
for (child in children) {
	if (child.needRegex) {
		let r = Regex(child.part)
		if (r.matches(part).isSome()) {
			return child
		}
	} else {
		if (child.part == part || child.isWild) {
			return child
		}
	}
}
```

## ğŸ’«handler

![[Pasted image 20250216094150.png|475]]

> å…³é”®æŠ€æœ¯: æ›¿æ¢replacementä¸­çš„$1, $2

```java
	// æ›¿æ¢rewrite.replacementä¸­çš„$1, $2ç­‰
	var str = rewrite.getOrThrow().replacement
	let rule = "(\\$\\d+)"
	let regex = Regex(rule)
	var matcher = regex.matcher(str)

	let result = matcher.findAll()
	if (result.isNone()) {
		return str
	}
	for (r in result.getOrThrow()) {
		let index = stringToInt(r.matchStr()[1..]) - 1
		if (index < matchArray.size && index >= 0) {
			str = str.replace(r.matchStr(), matchArray[index])
		}
	}
```

# â™¾ï¸è´Ÿè½½å‡è¡¡ç®—æ³•
## ğŸ’«å¹³æ»‘åŠ æƒè½®è¯¢
![[Pasted image 20250305093550.png]]






