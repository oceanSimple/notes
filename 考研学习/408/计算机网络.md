---
cssclass:
  - img-grid
---

# ♾️数据链路层
## 功能
- 为网络层提供服务
	- 无确认的无连接服务
	- 有确认的无连接服务
	- 有确认的面向连接服务
- 链路管理
- 封装成帧
	- MTU：最大传送单元
	- HDLC协议：规定标识符F为帧的开始和结束
- 流量控制
- 差错控制

## 组帧
- 在网络中信息是以帧为最小单位进行传输

方法：
1. 字符计数法：在帧头用一个计数字段标明帧的长度
	- 问题：如果计数字段出错，后面所有数据全部无效
2. 字符填充和收尾定界符法
	- SOH-开始，EOT-结束，ESC-转义字符
3. 零比特填充的首尾标志法
	- 用01111110表示帧的开始和结束
	- 数据中有5个连续的1时，自动在后面插一个0.接收端会删除0恢复数据
	- 优点：硬件实现，性能更优
4. 违规编码法

## 差错控制❄️
> 分为检错编码和纠错编码

检错编码：
- 奇偶校验码：1位检验位，保证数据中的1为奇数/偶数
	- 问题：只能检查奇数位出错，即如果2位出错，则无法检查
- 循环冗余CRC

纠错编码
- 海明码

## 流量控制和可靠传输机制
停止-等待协议：发送完一帧后，必须等待确认信息后，才能发送下一帧

滑动窗口协议：
- 停止等待协议：1个发送端口-1个接收端口
- 后退N帧协议（GBN）：多个发送窗口-1个接收端口
	- 累计确认：某一帧的确认，代表该帧前所有的数据帧都成功接收
- 选择重传协议SR：多个发送窗口-多个接收端口，通常相同

信道利用率=（L/C）/T
- L是周期内发送L比特的数据
- C是发送方的数据传输速率
- T是从开始发送到接收到确认帧的时间，通常为L/C+2R(R为单向传播时延)
信道吞吐率=信道利用率 x 发送方的发送速率

## 介质访问控制
### 信道划分介值访问控制
1. FDM-频分多路复用
	- 将多路基带信号调制到不同频率载波上，再叠加成一个复合信号
2. TDM-时分多路复用
	- 将物理信道按时间分成多个时间片
	- STDM-统计时分多路复用/异步时分多路复用
3. WDM-波分多路复用
	- 光的频分多路复用
4. CDM-码分多路复用
	- CDMA-码分多址
	- 各站点的码片序列相互正交
	- 计算题暂略

### 随机访问介质访问控制

```ad-note
用户可以随意决定是否发送数据，如果发生碰撞，则按照一定规则重传。
实质是将广播信道转化为点到点信道
```


> ALOHA协议

- 纯ALOHA：不检测信道是否被占用，直接发送，等待发送成功的确认消息或重发
- 时隙ALOHA：将各站在时间上同步，将时间划分为多个等长时隙，要求只能在时隙开始时发送帧

> CSMA协议-载波监听多路访问：监听共用信道是否空闲

1. 1-坚持CSMA
	- 若信道忙碌，则持续监听直到空闲
	- 当两个节点同时监听信道，一旦信道空闲，则两个节点同时发送帧，造成碰撞

2. 非坚持CSMA
	- 如果信道空闲，直接发送；如果信道忙碌，放弃监听，过随机时间后访问

3. p-坚持CSMA
	- 如果信道空闲，则有p概率发送，1-p概率推迟到下一个时隙；如果信道忙碌，持续监听

![[Pasted image 20240506141153.png]]

> CSMA/CD协议-碰撞检测

- 争用期：以太网端到端的往返时间2r
- 最短帧长=总线传播时延 x 数据传输速率 x 2 
	- `因为是往返时延，所以要x2`
- 截断二进制指数退避算法
	- 基本退避时间为争用期2r
	- 参数k为重传次数，不超过10.即如果重传次数大于10时，k=10
	- 从0，1，2，3...2<sup>k</sup> -1中随机取一个数作为p，重传时间即2rp
	- 重传次数大于16时，不再继续重传


> CSMA/CA协议-碰撞避免❄️

- 只要用于无线局域网


### 轮询访问：令牌传递协议

类比互斥锁



# ♾️网络层
## 网络层功能
> 中继系统

- 物理层：转发器,集线器
- 数据链路层：网桥,交换机
- 网络层：路由器
- 网络层以上：网关

> 路由与转发

- 路由选择：根据分布式算法，动态改变所选择的路由
- 分组转发：根据转发表将用户的IP数据报从合适的端口转发

> SDN - 软件定义网络

网络层可以划分为数据平面/转发平面和控制平面
SDN架构，在控制平面有一个逻辑上的远程控制器，为每个分组计算最佳路由。通过openflow协议将转发表下发个路由器。
路由器的工作：收到分组，查找转发表，转发分组

- 北向接口：对上层应用开发者提供的编程接口
- 南向接口：SDN控制器与转发设备建立双向会话的接口
- 东西向接口：SDN控制器集群内部控制器之间的通信接口

优缺点
- 优点：全局集中，灵活可编程，性能扩展，降低成本
- 缺点：易受攻击，全局崩溃，瓶颈问题

> 拥塞控制

在通信子网中，因出现过量分组而引发网络性能下降的现象

与流量控制的区别
- 流量控制：发送端到接收端之间的控制。抑制发送端的发送速率保证接收端接收
- 拥塞控制：确保子网能过传送待传送的数据，是全局性问题，涉及所有主机、路由器等因素

方法：
- 开环控制：静态
- 闭环控制：动态

## 路由算法
> 静态路由，动态路由

- 静态路由：网络管理员手工配置路由信息
- 动态路由：路由器通过与相连的其他路由器彼此交换信息，按照算法优化路由表，寻找最优寻路。

常见的动态路由算法：距离-向量算法，链路状态路由算法

> 距离-向量路由算法

路由表包含
- 每条路径的目的地-另一结点
- 路径的代价-距离跳数

所有节点必须参与距离向量交换，以保证有效性和一致性。
该算法的实质是迭代计算一条路由中的站段数或延迟时间，从而得到到达一个目标的最短通路。要求每个结点在更新时，将它的全部路由表发送给所有相邻节点


`RIP算法`
- 允许最大的跳数为15跳，16跳以上被认为不可到达

三个特点：
- 仅和相邻路由器交换信息。

- 交换的信息是当前本路由器所知道的全部信息，即自己的路由表。

- 按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息（当链路有变化，就不等30s了，比如某个网段不存在了，会立刻告诉。）

> 链路状态路由算法-OSPF

任务：
- 主动测试所有邻接结点的状态
- 定期将链路状态传播给所有其他结点

使用Dijkstra最短路径算法重新计算路由

与距离算法的区别：距离算法只跟相邻结点交谈，链路状态算法通过广播的方式与所有其他结点交谈。

> 层次路由

因特网将整个互联网划分为多个自治系统。

IGP：内部网关协议，有RIP，OSPF
EGP：外部网关协议，有BGP

## IPV4
### 分组格式
![[Pasted image 20240508135729.png]]
- 版本：IP协议版本，通常为4
- 首部长度：4位，以4B为单位，因此可以表示15x4B=60B长度
- 总长度：16位，以1B为单位。首部+数据之和的长度
- 标识：16位，分片后的标识符
- 标志：3位。最低位MF，1-后面还有分片。DF，DF=0 - 允许分片
- 片偏移：13位，单位为8B。因此除了最后一个分片，其他分片的长度是8B的整数倍
- 生存时间：8位，每经过一个路由-1
- 协议：8位。TCP-6，UPD-17
- 首部校验和：16位。只检验分组的首部
- 源地址，目标地址

```ad-note
- 单位注意：首部长度4B，总长度1B，片偏移8B
- 标识、标志、片偏移完成片的重组
```

### NAT
指将专用网络地址转换成共用地址，从而对外隐藏内部管理的IP地址

私有IP地址网段：
![[Pasted image 20240508140659.png]]

### CIDR
- 实际可指派地址数通常为2<sup>n</sup>-2
- 路由转发时，选择前缀最长的一个作为匹配的前缀-最长前缀匹配

### ARP，DHCP，ICMP
> ARP

- 用来完成IP到MAC的映射
- 路由转发时，源目IP不变，源目MAC不断变化

> DHCP

- 用于给主机动态分配IP地址
- 应用层协议，基于UDP
- 客户端和服务器均采用广播

> ICMP

差错报告报文：
- 终点不可达：无法交付数据报
- 源点抑制：因拥塞而丢弃数据报
- 时间超过：TTL为0
- 参数问题：首部字段有问题
- 重定向/改变路由：重定向
不发送差错报告的情况
- 报文是ICMP差错报告报文
- 只对第一个分片发送差错报告报文
- 对有组播地址的数据包不发送
- 特殊地址，如127.0.0.1之类不发送

询问报文：
- 回送请求和回答报文
- 时间戳请求和回答报文
- 地址掩码请求和回答报文
- 路由器询问和通告报文

## IPV6
解决IP地址耗尽问题：
- CIDR，使IP的分配更加合理
- NAT，节省全球IP
- IPV6，根本上解决问题

IPV6特点
- 128位
- 不允许分片
- 首部长度必须是8B的整数倍
- 增大了安全性，身份验证和保密功能
- 没有提供校验和字段（由数据链路层保证）

## 路由协议
### RIP
- 仅和相邻路由器交换信息
- 交换的是路由器的全部信息，路由表
- 每30s广播一次路由更新信息
- 最多允许15跳，防止不断循环再环路
- 不支持子网掩码和RIP广播。RIP2现在支持了

- 应用层协议，UDP
- 采用距离向量算法
- 若180s没收到相邻路由器的消息，则默认不可到达

缺点：
- 限制了网络的规模，最大距离15
- 路由器交换完整的路由表，开销大
- 坏消息传得慢：需要较长时间才能将此信息传送到所有路由器

### OSPF
与RIP的主要区别
- 洪泛法：向所有路由器发送消息
- 发送的是链路状态，即本路由器和那些路由器相邻以及该链路的度量/代价
- 只有链路状态发生变化才发送消息
- 网络层协议

其他特点
- 同一个目的网络有多条相同代价路径，实现负载均衡
- 路由器之间有鉴别功能，可以自主选择可信赖的路由器交流
- 支持子网划分和CIDR
- 每个路由器都能建立一个链路状态的全网拓扑结构图

五种分组类型
- 问候分组：心跳检测机制
- 数据库描述分组：向邻站发送自己的链路状态
- 链路状态请求分组：向其他路由器请求链路状态信息
- 链路状态更新分组：洪泛法对全网更新链路状态
- 链路状态确认分组：对更新分组的确认

### BGP
- 力求寻找一条能到达的比较好的路由，而不是最佳路由
- 路径向量协议，采用应用层协议，基于TCP。TCP用于建立不同路由器的会话连接

四种报文：
- 打开：与其他路由器建立连接
- 更新：发送某一路由消息，通知其它路由器更新
- 保活：确认邻站存货
- 通知：发送检测到的错误
![[Pasted image 20240509155800.png]]

## IP组播
- 目的：让源计算机一次发送的单个分组可以抵达用一个组地址标识的若干目标，并被它们正确接收
- 应用于UDP
- 一台主机可以同时属于多个组
- 主机组播只发送一份数据，数据在传输路径出现分叉时才将分组复制继续转发
- 组播需要组播路由器支持

> IP组播地址

- 范围：224.0.0.0 ~~ 239.255.255.255
- 组播地址只能是目的地址
- 对组播数据包不产生ICMP差错报文
- 组播分为：本局域网的硬件组播和因特网的组播。因特网组播最后还是得在局域网内硬件组播
- 32位IP地址的后23位与硬件地址对应，高位补0

> IGMP-因特网组管理协议

## 移动IP
三种功能实体：
- 移动节点：具有永久IP地址的移动站
- 本地代理：通常是连接在归属网络上的路由器
- 外地代理：通常是连接在被访网络上的路由器

外地代理的功能
- 为移动站创建一个临时地址，即转交地址
- 即使把转交地址告诉归属代理

移动ip的工作流程（举例说明），A网络在外地网络，想与B网络通信
- A在外地网络进行注册，获得一个转交地址
- 外地代理将该转交地址通知A网络的本地代理
A向B发送消息：以自己的主地址作为源地址发送
B向A发送消息：只能以A的主地址作为目的地址，因此信息会发送到A的本地代理中，本地代理将数据转发到A的转交地址，外部代理将数据叫个A主机

## 网络层设备
> 冲突域和广播域

- 中继器和集线器在物理层，不能隔离冲突域和广播域
- 网桥和交换机在数据链路层，隔离冲突域，不能隔离广播域
- 路由器在网络层，可以隔离冲突域和广播域


# ♾️传输层
## 传输层提供的服务
- 向上的应用层提供通信服务，属于面向通信部分的最高层，用户功能的最底层

传输层的功能
- 提供应用进程之间的逻辑通信，端到端。（网络层提供的是主机之间的逻辑通信）
- 复用和分用：复用指发送方不同的应用进程都可以使用同一个传输层协议传送数据；分用是指接收方的传输层在剥去报文首部后能将数据正确的交付给目的应用进程
- 对首部和`数据`进行差错检测
- 提供TCP和UDP两种不同协议

端口号：
- 0-1023：熟知端口号
- 1024-49151：登记端口号
- 49152-65532：客户端使用端口号


## UDP
- UDP仅在IP服务上加了两个最基本功能：复用分用和差错检测

UDP优点
- 无需建立连接
- 无连接状态，因此可以支持更多的活动客户机
- 分组首部开销小。TCP有20B，UDP仅8B
- 没有拥塞控制，应用层能更好控制数据的发送时间
- 支持一对一，一对多，多对一，多对多

UDP首部格式
![[Pasted image 20240513105522.png]]
- 长度：UDP数据报的长度，包括首部和数据
- 校验和：可选，检测UDP数据报是否有差错，如果不想用，直接全为0


```ad-info
UDP校验
```
- 检查首部和数据部分
![[Pasted image 20240513110502.png]]

## TCP
TCP的特点：
- 可靠、有序、无丢失、不重复
- 每一条TCP都是一对一的，点对点的
- 提供全双工通信
- 面向字节流

TCP报文段
![[Pasted image 20240514103330.png]]
> 前20B是固定的，后面有4N字节根据需要而增加，长度为4B的整数倍

- 序号：4B，序号字段的值指的是本报文段所发送的数据的`第一个字节`的序号
- 确认号：4B，指期望收到对方下一个报文段的第一个数据字节的序号。若确认号为N，表名序号N-1为止的所有数据全部收到
- 数据偏移：4位，指出TCP报文段的数据起始处距离TCP报文段的起始距离。单位是4B，4bit的最大值是15，因此TCP首部最大长度为60B
- 保留：6位，全0
- 紧急位URG：当URG=1时，表名紧急指针字段有效。与紧急指针字段配合使用
- 确认位ACK：连接建立后，ACK必须为1
- 推送位PSH：接收方TCP收到PSH=1的报文后，尽快交付给应用进程，而无需等缓存满后交付
- 复位位RST：TCP发生严重错误，必须释放连接后重新连接
- 同步位SYN：表示这是一个连接请求报文
- 终止位FIN：表明此报文段的发送方的数据发送完毕，请求释放连接
- 窗口：2B，允许对方发送的数据量
- 校验和：2B，类比UDP
- 紧急指针：2B，本报文段中紧急数据共有多少字节
- 选项：长度可变
- 填充：使整个首部长度为4B整数倍

TCP三次握手
![[Pasted image 20240514111203.png]]
四次挥手
![[Pasted image 20240514111229.png]]

```ad-info
流量控制
```
接收方根据自己接收缓存的大小，动态调整发送方的发送窗口大小

![[Pasted image 20240514112324.png]]

```ad-info
拥塞控制
```
指让网络能承受现有的网络负荷，是全局性过程
- 慢开始
	- 先令拥塞窗口cwnd=1，每收到一个新报文段的确认，cwnd++
	- 指数型增加
	- cwnd增大到ssthresh阈值时，改用拥塞控制算法
- 拥塞控制算法
	- 每经过一个往返时延RTT，cwnd+1
	- 线性增长
- 网络拥塞处理
	- ssthresh = cwnd / 2
	- cwnd = 1

快重传：当发送方连续收到3个重复ACK报文时，直接重传，无需等待重传计时器超时
快恢复：ssthresh = cwnd / 2；cwnd = ssthresh